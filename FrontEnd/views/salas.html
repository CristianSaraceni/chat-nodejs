<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../public/chat.css">

</head>
<body>
    <div class="row">
        <h1 id="tituloSala">Chat de </h1>      
    </div>
    <div class="row">
        <div id="sala" class="col-8">

        </div>
    </div>
    <div class="row">
        <div class="col-6">           
            <form >
                <textarea id="sms" name="message" rows="2" cols="60">The cat was playing in the garden.</textarea>
                <input id="enviarSms" type="submit" value="Enviar">
            </form>
        </div>
    </div>
    <div class="row">
       <a href="http://localhost:3000"><button id="cerrarSesion">Cerrar Sesion</button></a> 
    </div>

    <script>
            $(document).ready(function() { 
              $("#tituloSala").append(" " + sessionStorage.getItem("sala"));

              $("#cerrarSesion").click(function(e){       
                cerrarSesiones();
                sessionStorage.clear();
                });

                $("#enviarSms").click(function(e){ 
                  //  e.preventDefault();      
                    crearMensajes();
                    obtenerMensajes().then((mensajes) => {
                mensajes.forEach(element => {
                 $("#sala").append('<div>' + element.texto + '<p>' + element.fechaHora + '</p>' + '</div>')
                 });
         
                });
                });

                obtenerMensajes().then((mensajes) => {
                mensajes.forEach(element => {
                 $("#sala").append('<div style="background-color: gray">' + '<p>' + element.nick + ' dice:</p>'  + '<p>' + element.texto + '</p>'  + '<p>' + element.fechaHora + '</p>' + '</div>')
                 });
         
                });

            });

            // crear sesiones en la base de datos
   function cerrarSesiones(){
        console.log(JSON.stringify({"nombre": sessionStorage.getItem("sala"), "nick": sessionStorage.getItem("nick")}))
      let url = 'http://localhost:3001/api/sesiones/cerrar';
      return new Promise((resolve, reject) => {
      //find the user to the api users
      fetch(url,{
        method: 'POST',
        body: JSON.stringify({"nombre": sessionStorage.getItem("sala"), "nick": sessionStorage.getItem("nick")}),
        headers:{
            'Content-Type': 'application/json'
        }
      })
    .then((response) => response.json())
    .then((responseJson) => {
     
        console.log(responseJson)
        resolve(responseJson);
    })
    .catch((error) => {
        reject(error);
    });
  });
  }

  function crearMensajes(){
        console.log(JSON.stringify({"texto": $("#sms").val(), "nick": sessionStorage.getItem("nick"), "nombreSala": sessionStorage.getItem("sala")}))
      let url = 'http://localhost:3001/api/mensajes/crear';
      return new Promise((resolve, reject) => {
      //find the user to the api users
      fetch(url,{
        method: 'POST',
        body: JSON.stringify({"texto": $("#sms").val(), "nick": sessionStorage.getItem("nick"), "nombreSala": sessionStorage.getItem("sala")}),
        headers:{
            'Content-Type': 'application/json'
        }
      })
    .then((response) => response.json())
    .then((responseJson) => {
     
        console.log(responseJson)
        resolve(responseJson);
    })
    .catch((error) => {
        reject(error);
    });
  });
  }

  function obtenerMensajes(){
        console.log(JSON.stringify({"nombreSala": sessionStorage.getItem("sala")}))
        let nombreSala = sessionStorage.getItem("sala").replace(" ", "+");
        console.log(nombreSala)
        console.log(nombreSala.replace("+", " "))
      let url = `http://localhost:3001/api/mensajes/obtener/${nombreSala}`;
      console.log(url)
      return new Promise((resolve, reject) => {
      //find the user to the api users
      fetch(url,{
        method: 'GET',
        headers:{
            'Content-Type': 'application/json'
        }
      })
    .then((response) => response.json())
    .then((responseJson) => {
     
        console.log(responseJson)
        resolve(responseJson);
    })
    .catch((error) => {
        reject(error);
    });
  });
  }
    </script>
</body>
</html>